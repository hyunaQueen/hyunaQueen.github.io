---
title: "안드로이드 프레임워크 공부 6주차"
date: 2019-05-16 19:38:38 -0400
categories: Android Framework
---

안드로이드 바인더 IPC
=============
바인더는 원래 IPC(Inter Process Communication)도구이지만 안드로이드에서는 다른 프로세스에 있는 함수를 마치 현재 프로세스에 존재하는 함수처름 사용할 수 있게 해주는 RPC(Remote Procedure Call)를 지원하는데 주로 이용된다.

리눅스 메모리 공간과 바인더 드라이버
-------------
바인더를 이해하려면 먼저 안드로이드의 기반 커널인 리눅스 커널의 메모리 공간을 이해할 필요가 있다. 안드로이드의 프로세스는 리눅스와 마찬가지로 프로세스만의 고유한 가상 주소 공간에서 실행된다. 총 4GB에 달하는 가상 주소 공간은 3GB의 사용자 공간과 1GB의 커널 공간으로 나뉜다. 프로세스는 각자 독립된 주소 공간을 가지고 별개로 동작한다.
* 바인더는 리눅스의 뛰어난 메모리 관리 기법을 그대로 채용함으로써 커널 공간을 통한 데이터 전달시 데이터의 신뢰성을 확보할 수 있다.
* 사용자 공간에서 접근할 수 없는 공간인 커널 공간을 이용해 데이터를 주고 받기 때문에 IPC 간의 보안 문제도 동시에 해결할 수 있다.

안드로이드 바인더 모델
-------------
IPC 데이터는 함수 호출과 관련된 내용, 즉 사용하고자 하는 서비스에 해당하는 번호와 호출할 함수명, 바인더 프로토콜(BINDER PROTOCOL)로 구성된다. 먼저 서비스 번호는 안드로이드에서 동작중인 여러 서비스를 구분하기 위한 것이다. 함수명은 서비스 서버에서 동작하는 여러 서비스 가운데 서비스 클라이언트가 호출할 함수를 찾기 위한 것이다. 그리고 마지막으로 바인더 프로토콜은 바인더 드라이버와 바인더를 이용하는 프로세스 간의 IPC 데이터를 처리하는 규약이다. 이러한 구성 요소는 IPC 데이터의 각 변수로 저장된다. 

### 바인더 IPC 데이터의 전달
* 바인더 드라이버는 문자 디바이드 드라이버처럼 open() 이나 ioctl()과 같은 시스템 콜을 통해 접근 가능
* 시스템 콜인 open()함수는 바인더 드라이어브이 binder_open()함수와 연결
<img src="https://user-images.githubusercontent.com/48199401/57860703-4ac99900-7830-11e9-98fb-8a6767dc4cc4.PNG">
바인더를 통해 RPC를 시도하는 RPC를 시도하는 애플리케이션은 open()시스템 콜을 통해 바인더 드라이버의 파일 디스크립터를 얻는다. 그리고 mmap()시스템 콜을 통해 커널 내에서 IPC 데이터를 수신하기 위한 공유 공간을 확보 한다. 마지막으로 ioctl()함수의 인자로 바인더 드라이버에 IPC데이터를 전달한다.

### 바인더 IPC 데이터의 흐름
<img src="https://user-images.githubusercontent.com/48199401/57861136-08548c00-7831-11e9-9c4a-7dd2c1c2cff2.PNG">
* 서비스 계층 : 특정 기능을 수행하는 서비스의 함수가 존재하는 계층
* RPC 계층 : 서비스 클라이언트는 이 계층에서 서비스의 함수를 호출하기 위한 RPC 코드와 RPC 데이터를 생성
* IPC 계층 : RPC 계층에서 만든 RPC 코드와 RPC 데이터를 바인더 드라이버에서 전달하기 위찬 바인더 IPC 데이터로 캡슐화하는 역할을 한다.
* 바인더 드라이버 계층 : IPC계층으로부터 전달받은 바인더 IPC 데이터를 통해 서비스를 가진 서비스 서버를 찾은 후 IPC 데이터를 전달

### 바인더 프로토콜
바인더 프로토콜은 바인더 IPC데이터에 포함되어 IPC 계층에서 바인더 드라이버로 전달되거나 바인더 드라이버에서 IPC 계층으로 전달된다. 바인더 프로토콜은 전달방향에 따라 두 가지로 분류된다.
* 'BINDER COMMAND PROTOCOL' : IPC 계층에서 바인더 드라이버로 전송될 때
* 'BINDER RETURN PROTOCOL' : 바인더 드라이버에서 IPC 계층으로 전달될 때

### RPC 코드와 RPC 데이터
서비스 클라이언트는 서비스 서버에 존재하는 서비스의 함수를 사용하기 위해 각 함수에 해당하는 식별자를 바인더 IPC 데이터에 담아 전달하는데, 이를 **RPC 코드** 라고 한다. 그리고 함수의 인자 역시 IPC 데이터에 담아 전달하는데, 이것은 **RPC 데이터**라고 한다.

### 바인더 어드레싱
안드로이드에는 다양한 서비스를 모두 목록화해서 관리하는 컨텍스트 매니저라는 특별한 프로세스가 있다. 컨텍스트 매니저는 서비스마다 핸들이라는 번호 값을 할당하고, 서비스의 추가/검색 등의 관리 기능을 수행한다. 
* 바인더 드라이버는 IPC 데이터의 핸들을 가지고 서비스 서버를 찾는데, 이러한 과정을 바인더 어드레싱이라고 한다. 바인더 어드레싱을 위해서 먼저 서비스 서버는 자신이 가진 서비스에 대한 접근 정보를 컨텍스트 매니저에 등록해야 한다.
