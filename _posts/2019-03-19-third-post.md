---
title: "안드로이드 프레임워크 공부 1일차 - 3"
date: 2019-03-21 17:10:48 -0400
categories: Android Framework init
---

init 프로세스
=============

3.1 init 프로세스의 실행 과정
-------------

init 프로세스 실행은 start_kernel() 함수, init_post() 함수, run_init_process() 함수가 순차적으로 실행되면서 부팅이 되고 마지막 단계에서 init프로세스를 실행한다.
init 프로세스가 하는 일은?
=> init 프로세스를 살펴보는거보단 실제 구현코드를 살펴보자!

3.2 init 프로세스의 소스 코드 분석
-------------

init 프로세스는 크게 4가지 기능을 수행한다.
### init.rc파일 분석 및 실행
init.rc파일 파싱 -> init.{hardware}.rc파일 파싱 -> earyly-init 액션 리스트 실행 -> early-boot & boot 액션 리스트 실행 -> 서비스 리스트 실행
### 디바이스 드라이버 노드 생성
디렉토리 생성 및 마운트 -> 디바이스 정적 노드 생성 -> POLL이벤트 등록
### 자식 프로세스 종료 처리
SIGCHLD 시그널 핸들러 등록 -> UDS를 위한 소켓 생성 -> POLL이벤트 등록
### 프로퍼티 서비스
프로퍼티 초기화 -> 프로퍼티 초기 설정 -> 프로퍼티 서비스 실행 -> POLL이벤트 등록

3.3 init.rc 파일 분석 및 실행
-------------
## 3.3.1 액션 리스트
액션 리스트의 'on init'섹션에서는 환경변수를 등록하고, 시스템 동작시에 필요한 파일 및 디렉터리생성과 퍼미션을 조작한다. 그후 시스템 동작관련 디렉터리를 마운트.
루트 파일 시스템은 크게 셸 유틸리티, 라이브러리, system 디렉터리 그리고 data 디렉터리로 나뉜다.
'on boot'섹션에서는 애플리케이션 종료 조건 설정, 애플리케이션 구동에 필요한 디렉터리 및 파일퍼미션 설정을 한다.

## 3.3.2 서비스 리스트
'service'섹션은 init프로세스가 실행시키는 프로세스를 기술한다. 일회성 프로그램이나 백그라운드로 구동되면서 애플리케이션이나 시스템 운용에 관여하는 데몬 프로세스가 있다.
'service'섹션의 프로세스는 모두 서비스 리스트에 등록되며, init 프로세스가 실행되면서 서비스 리스트에 등록된 프로세스를 순차적으로 실행한다.

## 3.3.3 init.rc 파싱 코드 분석
1. next_token()함수는 인자로 넘겨받은 문자열을 라인 단위로 나눈 후 lookup_keyword()함수를 호출한다.
2. lookup_keywork() 함수는 init.rc파일의 각 라인에서 첫 단어에 해당하는 keyword_list구조체 배열에서 배열의 번호를 반환한다.
3. lookup_keyword() 함수가 반환하는 KEYWORD 리스트 번호를 가진 keyword_list 구조체 배열을 찾는다.

## 3.3.4 액션 리스트 및 서비스 리스트의 실행
액션 리스트와 서비스 리스트는 drain_action_queue()함수를 통해 실행된다.
drain_action_queue()함수의 내용
1. action_remove_queue_head() 함수를 통해 전역으로 선언된 action_queue 연결 리스트의 해더를 가져온다. action_queue는 실행할 명령어들의 액션리스트를 가지고 있다.
2. action_queue로부터 가져온 액션 리스트를 command구조체로 변환한다.
3. command 구조체의 func 변수는 액션 리스트의 명령어에 연결된 실행 함수를 가르킨다.

